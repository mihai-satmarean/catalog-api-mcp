# Multi-stage build for catalog-api-mcp using Obot's phat image
# Reference: https://github.com/obot-platform/mcp-images

# Stage 1: Build TypeScript only (no native modules yet)
FROM node:20-alpine AS builder

WORKDIR /build

# Copy source files
COPY bmac-mcp-server/src ./src
COPY bmac-mcp-server/tsconfig.json ./
COPY bmac-mcp-server/package*.json ./

# Install only TypeScript and build tools
RUN npm install typescript @types/node --save-dev

# Build TypeScript to JavaScript
RUN npx tsc

# Stage 2: Final image using Obot's phat image (has Node.js, npm, Python, etc.)
FROM ghcr.io/obot-platform/mcp-images/phat:main

USER root

WORKDIR /app

# Copy package files first
COPY bmac-mcp-server/package*.json ./

# Install ALL dependencies including better-sqlite3 (will compile for phat's environment)
RUN npm ci --production

# Copy the built JavaScript from builder
COPY --from=builder /build/dist ./dist

# Create data directory for SQLite database
RUN mkdir -p /app/data && chmod 777 /app/data

# Create nanobot.yaml configuration (following Obot's hubspot example)
RUN cat > /nanobot.yaml <<'EOF'
publish:
  mcpServers: [server]

mcpServers:
  server:
    command: node
    args: [/app/dist/index.js]
    env:
      DATABASE_URL: ${DATABASE_URL}
      NODE_ENV: production
EOF

RUN chown nanobot:nanobot /nanobot.yaml

# Set default environment variables
ENV DATABASE_URL=/app/data/sqlite.db
ENV NANOBOT_STATE=/app/data/nanobot.db

# Ensure proper ownership
RUN chown -R nanobot:nanobot /app

USER nanobot

# Use nanobot entrypoint (already in phat image)
ENTRYPOINT ["nanobot"]

# Listen on port 8099 (Obot standard for MCP servers)
CMD ["run", "--listen-address", ":8099", "-e", "DATABASE_URL", "/nanobot.yaml"]
