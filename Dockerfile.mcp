# Multi-stage build for catalog-api-mcp with nanobot and SQLite

# Stage 1: Build the MCP server
FROM node:20-alpine AS builder

WORKDIR /build

# Copy all MCP server files first (needed for prepare script)
COPY bmac-mcp-server/ ./

# Install dependencies (this will also run the prepare/build script)
RUN npm ci

# Stage 2: Final image with obot base
FROM ghcr.io/obot-platform/mcp-images-phat:main

USER root

# Install SQLite runtime dependencies
RUN apk add --no-cache \
    sqlite \
    sqlite-libs

# Copy the built MCP server
WORKDIR /app
COPY --from=builder /build/dist ./
COPY --from=builder /build/node_modules ./node_modules
COPY --from=builder /build/package.json ./package.json

RUN chmod +x ./index.js

# Create directory for SQLite database and ensure it's writable
RUN mkdir -p /app/data && \
    chmod 777 /app/data

# Create nanobot.yaml configuration
RUN cat > /app/nanobot.yaml <<'EOF'
publish:
  mcpServers: [server]

mcpServers:
  server:
    command: node
    args: [./index.js]
    env:
      DATABASE_URL: /app/data/sqlite.db
      PORT: ${PORT}
EOF

ENV DATABASE_URL=/app/data/sqlite.db
ENV PORT=3000

EXPOSE 3000

# Use nanobot to run the MCP server
CMD ["/usr/local/bin/nanobot", "run", "--listen-address", ":3000", "/app/nanobot.yaml"]
