# Production image using obot's base
FROM ghcr.io/obot-platform/mcp-images-phat:main

# Copy the pre-built application and dependencies from bmac-mcp-server directory
COPY bmac-mcp-server/dist/index.js ./catalog-api-mcp
COPY bmac-mcp-server/node_modules ./node_modules
COPY bmac-mcp-server/package.json ./package.json

USER root

# Make executable
RUN chmod +x ./catalog-api-mcp

RUN cat > nanobot.yaml <<'EOF'
publish:
  mcpServers: [server]

mcpServers:
  server:
    command: node
    args: [./catalog-api-mcp]
    env:
      DATABASE_URL: ${DATABASE_URL}
EOF

RUN chown 1000 nanobot.yaml

# Set default PORT if not provided
ENV PORT=3000

ENTRYPOINT ["sh", "-c"]

CMD ["nanobot run --listen-address :${PORT} -e DATABASE_URL ./nanobot.yaml"]

USER 1000

